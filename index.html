<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUJUTSU KAISEN: DOMAIN CLASH</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Rajdhani', sans-serif; background: #050505; color: #fff; overflow: hidden; user-select: none; }
        
        #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; transition: background 0.5s; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Loading */
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050505; display: flex; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        #loadingScreen h2 { font-size: 2em; color: #ff0844; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Title */
        .title { font-family: 'Orbitron'; font-size: 4em; font-weight: 900; letter-spacing: 6px; margin-bottom: 10px; background: linear-gradient(135deg, #ff0844, #ffb199, #ff0844); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; }
        
        /* Screens */
        #modeScreen, #selectionScreen, #mapScreen { min-height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .modes-grid, .characters-grid, .maps-grid { display: grid; gap: 15px; padding: 20px; }
        .modes-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); max-width: 1000px; }
        .characters-grid { grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); max-width: 1200px; max-height: 60vh; overflow-y: auto; background: rgba(20, 0, 10, 0.8); border: 2px solid rgba(255, 8, 68, 0.3); border-radius: 20px; }
        .maps-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); max-width: 1000px; }
        
        .mode-card, .character-card, .map-card { background: linear-gradient(135deg, rgba(30, 10, 20, 0.95), rgba(50, 10, 30, 0.95)); border: 2px solid rgba(255, 8, 68, 0.3); border-radius: 12px; padding: 20px; cursor: pointer; transition: 0.2s; text-align: center; }
        .mode-card:hover, .character-card:hover, .map-card:hover { transform: translateY(-5px); border-color: #ff0844; box-shadow: 0 5px 20px rgba(255, 8, 68, 0.6); }
        .character-card.selected, .map-card.selected { border: 3px solid #00ff88; box-shadow: 0 0 20px rgba(0, 255, 136, 0.5); }
        
        .mode-icon, .character-portrait, .map-preview { font-size: 3em; margin-bottom: 10px; }
        .mode-name, .character-name, .map-name { font-weight: 900; font-size: 1.2em; color: #ff0844; }
        
        /* Game Screen */
        #gameScreen { display: none; width: 100%; height: 100vh; }
        #gameCanvas { display: block; width: 1200px; height: 600px; background: rgba(0,0,0,0.5); border: 4px solid #333; margin: 0 auto; border-radius: 10px; }
        
        /* HUD */
        .hud { width: 1200px; margin: 10px auto; }
        .top-hud { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .round-info, .coins-display { font-size: 1.5em; font-weight: 900; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        
        .health-bars { display: flex; justify-content: space-between; gap: 40px; margin-bottom: 10px; }
        .health-group { flex: 1; }
        .health-label { font-size: 1.2em; font-weight: 900; margin-bottom: 5px; display: flex; justify-content: space-between; text-shadow: 2px 2px 0 #000; }
        .health-bar-outer, .stamina-bar-outer, .ultimate-bar-outer { background: rgba(0,0,0,0.8); border: 2px solid #555; border-radius: 12px; overflow: hidden; }
        .health-bar-outer { height: 25px; }
        .stamina-bar-outer, .ultimate-bar-outer { height: 8px; margin-top: 3px; }
        .health-bar-inner { height: 100%; transition: width 0.3s; }
        .health-bar-inner.player { background: linear-gradient(90deg, #00ff88, #00cc66); box-shadow: 0 0 10px rgba(0, 255, 136, 0.5); }
        .health-bar-inner.enemy { background: linear-gradient(90deg, #ff0844, #ff6b9d); box-shadow: 0 0 10px rgba(255, 8, 68, 0.5); }
        .stamina-bar-inner { height: 100%; background: linear-gradient(90deg, #00ff88, #00aa66); width: 100%; transition: width 0.1s; }
        .ultimate-bar-inner { height: 100%; background: linear-gradient(90deg, #ffd700, #ffaa00); width: 0%; transition: width 0.2s; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        
        .combo-display { font-size: 3em; font-weight: 900; color: #ffd700; text-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700; position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; display: none; animation: comboAppear 0.5s; }
        @keyframes comboAppear { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        
        .controls-footer { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); padding: 12px 30px; border-radius: 10px; border: 1px solid #555; font-size: 0.85em; }
        .controls-footer span { margin: 0 10px; color: #aaa; }
        .controls-footer b { color: #ff0844; }
        
        #domainOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; align-items: center; justify-content: center; }
        #domainText { font-family: 'Orbitron'; font-size: 5em; font-weight: 900; color: #fff; text-shadow: 0 0 30px currentColor; animation: domainFlash 3s forwards; }
        @keyframes domainFlash { 0% { opacity: 0; transform: scale(0.5); } 20% { opacity: 1; transform: scale(1.2); } 80% { opacity: 1; } 100% { opacity: 0; transform: scale(1.5); } }
        
        #gameOver { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(10, 0, 5, 0.98); border: 4px solid #ff0844; border-radius: 20px; padding: 40px; z-index: 100; text-align: center; }
        button { font-family: 'Orbitron'; font-size: 1.2em; padding: 12px 35px; background: linear-gradient(135deg, #ff0844, #aa0000); border: 2px solid #fff; color: white; cursor: pointer; margin: 10px; transition: 0.2s; border-radius: 5px; }
        button:hover { transform: scale(1.1); filter: brightness(1.2); }
        button.secondary { background: linear-gradient(135deg, #333, #555); }
    </style>
</head>
<body>
    <canvas id="bgCanvas"></canvas>
    
    <div id="loadingScreen">
        <h2>âš¡ LOADING CURSED ENERGY...</h2>
        <p style="margin-top: 20px; color: #aaa;">Preparing 5 characters...</p>
    </div>
    
    <div class="container">
        <div id="modeScreen">
            <h1 class="title">JUJUTSU KAISEN</h1>
            <p style="font-size: 1.5em; color: #aaa; margin-bottom: 40px;">DOMAIN CLASH</p>
            <div class="modes-grid" id="modesContainer"></div>
        </div>

        <div id="selectionScreen">
            <h2 style="font-size: 2em; color: #ff0844; margin-bottom: 10px;">SELECT CHARACTER</h2>
            <div class="characters-grid" id="charactersContainer"></div>
            <button onclick="confirmSelection()">CONTINUE</button>
            <button class="secondary" onclick="backToModes()">BACK</button>
        </div>

        <div id="mapScreen">
            <h2 style="font-size: 2em; color: #ff0844; margin-bottom: 20px;">SELECT BATTLEFIELD</h2>
            <div class="maps-grid" id="mapsContainer"></div>
            <button onclick="startBattle()">START BATTLE</button>
            <button class="secondary" onclick="backToSelection()">BACK</button>
        </div>

        <div id="gameScreen">
            <div id="domainOverlay"><div id="domainText">DOMAIN EXPANSION</div></div>
            <div id="comboDisplay" class="combo-display"></div>

            <div class="hud">
                <div class="top-hud">
                    <div class="round-info">BATTLE START!</div>
                    <div class="coins-display">ðŸ’° 0</div>
                </div>
                
                <div class="health-bars">
                    <div class="health-group">
                        <div class="health-label">
                            <span id="p1Name">PLAYER</span>
                            <span id="p1HP">100/100</span>
                        </div>
                        <div class="health-bar-outer">
                            <div class="health-bar-inner player" id="p1Health" style="width: 100%;"></div>
                        </div>
                        <div class="stamina-bar-outer">
                            <div class="stamina-bar-inner" id="p1Stamina" style="width: 100%;"></div>
                        </div>
                        <div class="ultimate-bar-outer">
                            <div class="ultimate-bar-inner" id="p1Ultimate" style="width: 0%;"></div>
                        </div>
                    </div>
                    
                    <div class="health-group">
                        <div class="health-label">
                            <span id="e1Name">ENEMY</span>
                            <span id="e1HP">100/100</span>
                        </div>
                        <div class="health-bar-outer">
                            <div class="health-bar-inner enemy" id="e1Health" style="width: 100%;"></div>
                        </div>
                        <div class="stamina-bar-outer">
                            <div class="stamina-bar-inner" id="e1Stamina" style="width: 100%;"></div>
                        </div>
                        <div class="ultimate-bar-outer">
                            <div class="ultimate-bar-inner" id="e1Ultimate" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <canvas id="gameCanvas" width="1200" height="600"></canvas>
            
            <div class="controls-footer">
                <span><b>WASD</b>: Move</span>
                <span><b>SHIFT</b>: Block</span>
                <span><b>SPACE</b>: Dodge</span>
                <span><b>J/K/L/;/'</b>: Attacks</span>
                <span><b>U/I/O</b>: Specials</span>
                <span><b>P</b>: Ultimate</span>
            </div>
        </div>

        <div id="gameOver">
            <h2 id="gameOverTitle">VICTORY!</h2>
            <p style="margin: 20px 0; font-size: 1.2em;" id="gameOverText"></p>
            <button onclick="location.reload()">MAIN MENU</button>
        </div>
    </div>

<script>
// ========== GAME VARIABLES ==========
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const bgCanvas = document.getElementById('bgCanvas');

let CHARACTERS = [];
let MAPS = [];
let gameActive = false;
let selectedChars = [];
let selectedMap = null;
let fighters = [];
let particles = [];
let keys = {};

// ========== PARTICLE CLASS FOR EFFECTS ==========
class Particle {
    constructor(x, y, color, type = 'spark') {
        this.x = x;
        this.y = y;
        this.vx = (Math.random() - 0.5) * 8;
        this.vy = (Math.random() - 0.5) * 8 - 2;
        this.life = 30;
        this.maxLife = 30;
        this.color = color;
        this.size = type === 'text' ? 1 : Math.random() * 4 + 2;
        this.type = type;
        this.text = '';
    }
    
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.3; // Gravity
        this.life--;
        this.vx *= 0.98;
    }
    
    draw() {
        const alpha = this.life / this.maxLife;
        ctx.globalAlpha = alpha;
        
        if (this.type === 'text') {
            ctx.font = 'bold 24px Orbitron';
            ctx.fillStyle = this.color;
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.strokeText(this.text, this.x, this.y);
            ctx.fillText(this.text, this.x, this.y);
        } else {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            
            // Glow effect
            ctx.shadowBlur = 15;
            ctx.shadowColor = this.color;
            ctx.fill();
            ctx.shadowBlur = 0;
        }
        
        ctx.globalAlpha = 1;
    }
}

// ========== FIGHTER CLASS ==========
class Fighter {
    constructor(x, y, charData, isPlayer) {
        this.x = x;
        this.y = y;
        this.width = 50;
        this.height = 80;
        this.char = charData;
        this.isPlayer = isPlayer;
        
        this.maxHealth = 100;
        this.health = 100;
        this.speed = charData.speed || 6;
        
        this.vx = 0;
        this.vy = 0;
        this.facing = isPlayer ? 1 : -1;
        this.onGround = true;
        
        this.cooldowns = {};
        Object.keys(charData.moves).forEach(key => this.cooldowns[key] = 0);
        
        this.stunned = 0;
        this.invuln = 0;
        this.ultimateCharge = 0;
        
        this.maxStamina = 100;
        this.stamina = 100;
        this.staminaRegen = 0.5;
        
        this.blocking = false;
        this.parryWindow = 0;
        this.parrySuccessTime = 0;
        
        this.combo = 0;
        this.lastAttackTime = 0;
        this.hitstun = 0;
        this.knockbackX = 0;
        this.knockbackY = 0;
    }

    update() {
        if (this.hitstun > 0) {
            this.hitstun--;
            this.x += this.knockbackX;
            this.y += this.knockbackY;
            this.knockbackX *= 0.85;
            this.knockbackY *= 0.85;
            if (Math.abs(this.knockbackX) < 0.5) this.knockbackX = 0;
            if (Math.abs(this.knockbackY) < 0.5) this.knockbackY = 0;
            return;
        }
        
        if (this.stunned > 0) {
            this.stunned--;
            return;
        }

        if (this.invuln > 0) this.invuln--;
        if (this.parryWindow > 0) this.parryWindow--;
        if (this.parrySuccessTime > 0) this.parrySuccessTime--;
        
        if (!this.blocking && this.stamina < this.maxStamina) {
            this.stamina = Math.min(this.maxStamina, this.stamina + this.staminaRegen);
        }
        
        if (this.blocking && this.stamina > 0) {
            this.stamina = Math.max(0, this.stamina - 0.3);
            if (this.stamina === 0) {
                this.blocking = false;
                this.stunned = 30;
                spawnText(this.x, this.y, "GUARD BREAK!", "#ff0000");
            }
        }
        
        for (let key in this.cooldowns) {
            if (this.cooldowns[key] > 0) this.cooldowns[key]--;
        }

        this.x += this.vx * (this.blocking ? 0.3 : 1);
        this.y += this.vy;
        
        if (!this.onGround) {
            this.vy += 0.8;
        } else {
            this.vy = 0;
        }
        
        const groundY = canvas.height - this.height - 20;
        if (this.y >= groundY) {
            this.y = groundY;
            this.onGround = true;
            this.knockbackY = 0;
        } else {
            this.onGround = false;
        }
        
        this.x = Math.max(0, Math.min(canvas.width - this.width, this.x));
        if (this.x === 0 || this.x === canvas.width - this.width) {
            this.knockbackX = 0;
        }
        this.y = Math.max(0, this.y);
        
        if (Date.now() - this.lastAttackTime > 2000) {
            this.combo = 0;
        }
    }

    draw() {
        // Shadow
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.beginPath();
        ctx.ellipse(this.x + this.width/2, canvas.height - 15, 25, 10, 0, 0, Math.PI*2);
        ctx.fill();

        // Body with glow
        ctx.fillStyle = this.char.color;
        if (this.invuln > 0 && Math.floor(Date.now() / 100) % 2 === 0) ctx.fillStyle = '#fff';
        if (this.parrySuccessTime > 0) ctx.fillStyle = '#ffd700';
        
        ctx.shadowBlur = 20;
        ctx.shadowColor = this.char.color;
        ctx.fillRect(this.x, this.y, this.width, this.height);
        ctx.shadowBlur = 0;

        // Icon
        ctx.font = '35px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(this.char.icon, this.x + this.width/2, this.y + 45);

        if (this.stunned > 0 || this.hitstun > 0) {
            ctx.font = '25px Arial';
            ctx.fillText('ðŸ’«', this.x + this.width/2, this.y - 10);
        }
        
        if (this.blocking) {
            ctx.strokeStyle = '#4169e1';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(this.x + this.width/2, this.y + this.height/2, 50, 0, Math.PI*2);
            ctx.stroke();
            
            if (this.parryWindow > 0) {
                ctx.strokeStyle = '#ffd700';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.arc(this.x + this.width/2, this.y + this.height/2, 55, 0, Math.PI*2);
                ctx.stroke();
                
                // Parry glow
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#ffd700';
                ctx.stroke();
                ctx.shadowBlur = 0;
            }
        }
    }

    takeDamage(amount, attacker, moveData = {}) {
        if (this.parryWindow > 0) {
            this.parrySuccessTime = 30;
            spawnText(this.x + this.width/2, this.y, "âš¡ PARRY!", "#ffd700");
            createHitEffect(this.x + this.width/2, this.y + this.height/2, '#ffd700');
            
            if (attacker) {
                attacker.stunned = 60;
                attacker.takeDamage(amount * 0.5, this);
            }
            
            if (this.isPlayer) {
                this.ultimateCharge = Math.min(100, this.ultimateCharge + 15);
            }
            return 0;
        }
        
        if (this.invuln > 0) {
            spawnText(this.x + this.width/2, this.y, "MISS", "#ccc");
            return 0;
        }
        
        if (this.blocking && this.stamina > 0) {
            amount *= 0.3;
            this.stamina = Math.max(0, this.stamina - 10);
            spawnText(this.x + this.width/2, this.y, "BLOCKED", "#4169e1");
            createHitEffect(this.x + this.width/2, this.y + this.height/2, '#4169e1');
            
            if (this.stamina === 0) {
                this.blocking = false;
                this.stunned = 30;
                spawnText(this.x + this.width/2, this.y - 30, "GUARD BREAK!", "#ff0000");
            }
        }
        
        this.health -= amount;
        if (this.health < 0) this.health = 0;
        spawnText(this.x + this.width/2, this.y, Math.floor(amount).toString(), "#ff0000");
        
        // Create hit effects
        createHitEffect(this.x + this.width/2, this.y + this.height/2, moveData.color || '#ff0844');
        
        if (moveData.knockback && attacker) {
            const direction = (this.x > attacker.x) ? 1 : -1;
            this.knockbackX = direction * (moveData.knockback / 10);
            
            if (moveData.launch) {
                this.knockbackY = -8;
                this.onGround = false;
            }
        }
        
        if (moveData.hitstun) {
            this.hitstun = moveData.hitstun;
        }
        
        if (attacker && attacker.isPlayer) {
            attacker.combo++;
            attacker.lastAttackTime = Date.now();
            attacker.ultimateCharge = Math.min(100, attacker.ultimateCharge + 3);
            
            // Show combo
            if (attacker.combo >= 2) {
                showCombo(attacker.combo);
            }
        }
        
        // Screen shake on heavy hit
        if (amount > 25) {
            screenShake();
        }
        
        return amount;
    }

    startBlock() {
        if (this.stamina > 10 && !this.stunned && !this.hitstun) {
            this.blocking = true;
            this.parryWindow = 10;
        }
    }
    
    stopBlock() {
        this.blocking = false;
        this.parryWindow = 0;
    }

    attack(moveType) {
        if (this.stunned > 0 || this.hitstun > 0 || this.cooldowns[moveType] > 0) return;
        
        const move = this.char.moves[moveType];
        if (!move) return;
        
        const staminaCost = moveType === 'light' ? 5 : moveType === 'heavy' ? 15 : 20;
        if (this.stamina < staminaCost) return;
        this.stamina -= staminaCost;

        if (moveType === 'ultimate') {
            if (this.ultimateCharge < 100) return;
            this.ultimateCharge = 0;
            showDomain(move.name, move.color);
        }

        this.cooldowns[moveType] = (move.cd || 1) * 60;

        // Create attack visual effect
        createAttackEffect(this.x + (this.facing > 0 ? this.width : 0), this.y + this.height/2, this.facing, move.color || this.char.color);

        const targets = fighters.filter(f => f.isPlayer !== this.isPlayer && f.health > 0);
        targets.forEach(target => {
            const distance = Math.abs(target.x - this.x);
            const moveRange = move.range || 100;
            
            if (distance < moveRange) {
                target.takeDamage(move.dmg, this, move);
            }
        });
        
        if (moveType !== 'ultimate') {
            this.ultimateCharge = Math.min(100, this.ultimateCharge + (moveType === 'light' ? 5 : 12));
        }
    }
}

// ========== VISUAL EFFECTS ==========
function createHitEffect(x, y, color) {
    for (let i = 0; i < 12; i++) {
        const p = new Particle(x, y, color);
        particles.push(p);
    }
}

function createAttackEffect(x, y, facing, color) {
    for (let i = 0; i < 8; i++) {
        const p = new Particle(x, y, color);
        p.vx = facing * (Math.random() * 5 + 3);
        p.vy = (Math.random() - 0.5) * 3;
        particles.push(p);
    }
}

function spawnText(x, y, text, color) {
    const p = new Particle(x, y, color, 'text');
    p.text = text;
    p.vy = -3;
    p.vx = (Math.random() - 0.5) * 2;
    particles.push(p);
}

function showCombo(count) {
    const display = document.getElementById('comboDisplay');
    display.textContent = `${count} HIT COMBO!`;
    display.style.display = 'block';
    setTimeout(() => display.style.display = 'none', 1000);
}

function showDomain(name, color) {
    const overlay = document.getElementById('domainOverlay');
    const text = document.getElementById('domainText');
    text.textContent = name;
    text.style.color = color;
    overlay.style.display = 'flex';
    bgCanvas.style.background = color;
    setTimeout(() => {
        overlay.style.display = 'none';
        if (selectedMap) bgCanvas.style.background = selectedMap.bgColor;
    }, 3000);
}

function screenShake() {
    canvas.style.transform = `translate(${Math.random()*6-3}px, ${Math.random()*6-3}px)`;
    setTimeout(() => canvas.style.transform = '', 100);
}

// ========== UPDATE UI ==========
function updateUI() {
    const player = fighters.find(f => f.isPlayer);
    const enemy = fighters.find(f => !f.isPlayer);
    
    if (player) {
        document.getElementById('p1Name').textContent = player.char.name;
        document.getElementById('p1HP').textContent = `${Math.floor(player.health)}/${player.maxHealth}`;
        document.getElementById('p1Health').style.width = `${(player.health / player.maxHealth) * 100}%`;
        document.getElementById('p1Stamina').style.width = `${(player.stamina / player.maxStamina) * 100}%`;
        document.getElementById('p1Ultimate').style.width = `${player.ultimateCharge}%`;
    }
    
    if (enemy) {
        document.getElementById('e1Name').textContent = enemy.char.name;
        document.getElementById('e1HP').textContent = `${Math.floor(enemy.health)}/${enemy.maxHealth}`;
        document.getElementById('e1Health').style.width = `${(enemy.health / enemy.maxHealth) * 100}%`;
        document.getElementById('e1Stamina').style.width = `${(enemy.stamina / enemy.maxStamina) * 100}%`;
        document.getElementById('e1Ultimate').style.width = `${enemy.ultimateCharge}%`;
    }
}

// ========== LOAD DATA ==========
async function loadGameData() {
    try {
        const [char, maps] = await Promise.all([
            fetch('characters-sample.json'),
            fetch('maps.json')
        ]);
        
        CHARACTERS = await char.json();
        MAPS = await maps.json();
        
        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('modeScreen').style.display = 'flex';
        
        populateModes();
        setupInput();
    } catch (error) {
        document.getElementById('loadingScreen').innerHTML = '<h2 style="color: #ff0000;">ERROR: Could not load data!<br><br>Make sure JSON files are present.</h2>';
    }
}

loadGameData();

function populateModes() {
    const modes = [
        { id: '1v1', name: '1v1 DUEL', icon: 'âš”ï¸', desc: 'Single battle' }
    ];
    
    const container = document.getElementById('modesContainer');
    modes.forEach(mode => {
        const card = document.createElement('div');
        card.className = 'mode-card';
        card.onclick = () => selectMode(mode.id);
        card.innerHTML = `<div class="mode-icon">${mode.icon}</div><div class="mode-name">${mode.name}</div><div class="mode-desc">${mode.desc}</div>`;
        container.appendChild(card);
    });
}

function selectMode(mode) {
    document.getElementById('modeScreen').style.display = 'none';
    document.getElementById('selectionScreen').style.display = 'flex';
    
    const container = document.getElementById('charactersContainer');
    CHARACTERS.forEach(char => {
        const card = document.createElement('div');
        card.className = 'character-card';
        card.onclick = () => selectCharacter(char);
        card.innerHTML = `<div class="character-portrait">${char.icon}</div><div class="character-name">${char.name}</div><div class="character-title">${char.title}</div>`;
        container.appendChild(card);
    });
}

function selectCharacter(char) {
    selectedChars.push(char);
    confirmSelection();
}

function confirmSelection() {
    if (selectedChars.length > 0) {
        document.getElementById('selectionScreen').style.display = 'none';
        document.getElementById('mapScreen').style.display = 'flex';
        
        const container = document.getElementById('mapsContainer');
        MAPS.forEach(map => {
            const card = document.createElement('div');
            card.className = 'map-card';
            card.onclick = () => selectMap(map);
            card.innerHTML = `<div class="map-preview">${map.icon}</div><div class="map-name">${map.name}</div>`;
            container.appendChild(card);
        });
    }
}

function selectMap(map) {
    selectedMap = map;
    document.querySelectorAll('.map-card').forEach(c => c.classList.remove('selected'));
    event.target.closest('.map-card').classList.add('selected');
}

function startBattle() {
    if (!selectedMap) return;
    
    document.getElementById('mapScreen').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'block';
    
    bgCanvas.style.background = selectedMap.bgColor;
    
    fighters = [
        new Fighter(200, canvas.height - 100, selectedChars[0], true),
        new Fighter(800, canvas.height - 100, CHARACTERS[Math.floor(Math.random() * CHARACTERS.length)], false)
    ];
    
    gameActive = true;
    gameLoop();
}

function backToModes() {
    selectedChars = [];
    document.getElementById('selectionScreen').style.display = 'none';
    document.getElementById('modeScreen').style.display = 'flex';
}

function backToSelection() {
    selectedMap = null;
    document.getElementById('mapScreen').style.display = 'none';
    document.getElementById('selectionScreen').style.display = 'flex';
}

// ========== INPUT ==========
function setupInput() {
    document.addEventListener('keydown', (e) => {
        keys[e.key.toLowerCase()] = true;
        
        if (!gameActive || fighters.length === 0) return;
        const player = fighters.find(f => f.isPlayer);
        if (!player) return;
        
        if (e.key === 'j') player.attack('light');
        if (e.key === 'k') player.attack('heavy');
        if (e.key === 'l') player.attack('sweep');
        if (e.key === ';') player.attack('antiair');
        if (e.key === "'") player.attack('lunge');
        if (e.key === 'u') player.attack('special1');
        if (e.key === 'i') player.attack('special2');
        if (e.key === 'o') player.attack('support');
        if (e.key === 'p') player.attack('ultimate');
        if (e.key === 'Shift') player.startBlock();
        if (e.key === ' ') {
            player.invuln = 12;
            player.stamina = Math.max(0, player.stamina - 20);
        }
    });
    
    document.addEventListener('keyup', (e) => {
        keys[e.key.toLowerCase()] = false;
        if (e.key === 'Shift' && fighters.length > 0) {
            const player = fighters.find(f => f.isPlayer);
            if (player) player.stopBlock();
        }
    });
}

// ========== GAME LOOP ==========
function gameLoop() {
    if (!gameActive) return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    fighters.forEach(f => {
        if (f.isPlayer && !f.stunned && !f.hitstun) {
            f.vx = 0;
            if (keys['a']) f.vx = -f.speed;
            if (keys['d']) f.vx = f.speed;
            if (keys['w'] && f.onGround) {
                f.vy = -15;
                f.onGround = false;
            }
        }
        
        if (!f.isPlayer) {
            const target = fighters.find(t => t.isPlayer && t.health > 0);
            if (target) {
                const distance = Math.abs(target.x - f.x);
                if (distance > 100) {
                    f.vx = (target.x > f.x) ? f.speed : -f.speed;
                } else {
                    f.vx = 0;
                    if (Math.random() < 0.02) {
                        const moves = ['light', 'heavy', 'special1'];
                        f.attack(moves[Math.floor(Math.random() * moves.length)]);
                    }
                }
            }
        }
        
        f.update();
        f.draw();
    });
    
    // Update particles
    particles = particles.filter(p => {
        p.update();
        p.draw();
        return p.life > 0;
    });
    
    updateUI();
    
    const playerAlive = fighters.some(f => f.isPlayer && f.health > 0);
    const enemyAlive = fighters.some(f => !f.isPlayer && f.health > 0);
    
    if (!playerAlive || !enemyAlive) {
        gameActive = false;
        document.getElementById('gameOverTitle').textContent = playerAlive ? 'VICTORY!' : 'DEFEAT!';
        document.getElementById('gameOver').style.display = 'block';
    }
    
    requestAnimationFrame(gameLoop);
}
</script>
</body>
</html>
